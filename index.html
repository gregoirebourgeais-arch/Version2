<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Atelier PPNC - Production lignes</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#005bff" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch((err) => console.error("SW registration failed", err));
      });
    }
  </script>
</head>

<body>
  <header class="app-header">
    <div class="app-title">
      <span class="app-main-title">Atelier PPNC</span>
      <span class="app-sub-title">Suivi Production & Arr√™ts</span>
      <span class="local-badge" title="Donn√©es stock√©es uniquement sur cet appareil, sans synchronisation externe">Mode hors ligne ¬∑ Donn√©es locales</span>
    </div>
    <div class="header-info" id="header-datetime">
      <!-- inject√© JS -->
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <select id="equipeSelector" class="equipe-selector">
        <option value="M">√âquipe M</option>
        <option value="AM">√âquipe AM</option>
        <option value="N">√âquipe N</option>
      </select>
      <button id="themeToggleBtn" class="theme-toggle">üåó Th√®me</button>
    </div>
  </header>

  <!-- Barre de navigation -->
  <nav class="top-nav">
    <button class="nav-btn active" data-section="atelier">Atelier</button>
    <button class="nav-btn" data-section="production">Production</button>
    <button class="nav-btn" data-section="arrets">Arr√™ts</button>
    <button class="nav-btn" data-section="organisation">Organisation</button>
    <button class="nav-btn" data-section="personnel">Personnel</button>
    <button class="nav-btn" data-section="validation">Validation DDM</button>
    <button class="nav-btn" data-section="historique">Historique √©quipes</button>
    <button class="nav-btn" data-section="manager">Manager (base d√©di√©e)</button>
  </nav>

  <main>
    <!-- PAGE ATELIER -->
    <section id="section-atelier" class="section visible">
      <h2>Vue d'ensemble Atelier</h2>

      <div class="atelier-grid">
        <div class="card">
          <h3>Production par ligne (aujourd'hui)</h3>
          <div id="atelier-lines-summary"></div>
        </div>

        <div class="card">
          <h3>Mise √† jour Excel</h3>
          <p class="helper-text">
            Charge un ou plusieurs fichiers du type <strong>Atelier_DATA_EQN_Qxxx_Sxx_hhmm.xlsx</strong>. Pas de limite √† 3 fichiers ni √† un seul import par jour.
          </p>

          <div class="import-actions">
            <input type="file" id="excelInput" accept=".xlsx,.xls" multiple />
            <button id="importExcelBtn" class="primary-btn">üì• Mise √† jour</button>
          </div>

          <div id="importStatus" class="import-status helper-text"></div>

          <div class="table-wrapper-horizontal">
            <table class="table" id="importsTable">
              <thead>
                <tr>
                  <th>Fichier</th>
                  <th>Q / S / Heure</th>
                  <th>Enregistrements</th>
                  <th>Import√© le</th>
                </tr>
              </thead>
              <tbody id="importsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>√âvolution des cadences</h3>
          <canvas id="atelierChart"></canvas>
          <p class="helper-text">
            Une courbe par ligne, bas√©e sur les enregistrements de production.
          </p>
        </div>

        <div class="card">
          <h3>Arr√™ts principaux</h3>
          <div class="table-wrapper-horizontal">
            <table class="table" id="atelier-arrets-table">
              <thead>
                <tr>
                  <th>Ligne</th>
                  <th>Sous-ligne</th>
                  <th>Machine</th>
                  <th>Dur√©e (min)</th>
                  <th>Commentaire</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Export Excel</h3>
          <p class="helper-text">
            Export pour pr√©sentation en r√©union (5 onglets : Synth√®se, Production, Arr√™ts, Organisation, Personnel).
          </p>

          <button id="exportPresentationBtn" class="primary-btn" style="margin-bottom: 15px;">
            üìà Export PR√âSENTATION
          </button>

          <p class="helper-text" style="margin-top: 20px;">
            RAZ d'√©quipe : exporte DATA + PR√âSENTATION de l'√©quipe finissante, puis reset complet.
          </p>

          <button id="razBtn" class="danger-btn">
            üîÑ RAZ √©quipe (double export + reset)
          </button>
        </div>
      </div>

      <div class="card">
        <h3>Recherche dans les imports Excel</h3>
        <div class="form-grid import-filters">
          <div class="form-group">
            <label for="importSearchInput">Recherche texte</label>
            <input type="text" id="importSearchInput" placeholder="Article, machine, commentaire..." />
          </div>
          <div class="form-group">
            <label for="importEquipeFilter">√âquipe</label>
            <select id="importEquipeFilter">
              <option value="">Toutes</option>
              <option value="M">M</option>
              <option value="AM">AM</option>
              <option value="N">N</option>
            </select>
          </div>
          <div class="form-group">
            <label for="importLineFilter">Ligne</label>
            <select id="importLineFilter">
              <option value="">Toutes les lignes</option>
            </select>
          </div>
        </div>

        <p class="helper-text" id="importResultsCount"></p>

        <div class="table-wrapper-horizontal">
          <table class="table" id="importResultsTable">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>√âquipe</th>
                <th>Ligne</th>
                <th>Machine</th>
                <th>Quantit√©</th>
                <th>Arr√™t (min)</th>
                <th>Cadence</th>
                <th>Commentaire</th>
                <th>Fichier</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAGE PRODUCTION -->
    <section id="section-production" class="section">
      <div class="production-layout">
        <aside class="lines-sidebar">
          <h3>Lignes</h3>
          <div class="lines-list" id="linesList"></div>
        </aside>

        <div class="line-content">
          <h2 id="currentLineTitle">Ligne</h2>

          <div class="card">
            <h3>Saisie production</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="prodStartTime">Heure d√©but</label>
                <input type="time" id="prodStartTime" />
              </div>

              <div class="form-group">
                <label for="prodEndTime">Heure fin</label>
                <input type="time" id="prodEndTime" />
              </div>

              <div class="form-group">
                <label for="prodQuantity">Quantit√© produite (colis)</label>
                <input type="number" id="prodQuantity" min="0" />
              </div>

              <div class="form-group">
                <label for="prodCodeArticle">Code article (optionnel)</label>
                <input type="text" id="prodCodeArticle" />
              </div>

              <div class="form-group">
                <label for="prodRemaining">Quantit√© restante (colis)</label>
                <input type="number" id="prodRemaining" min="0" />
              </div>

              <div class="form-group">
                <label for="prodCadenceManual">Cadence manuelle (colis/h)</label>
                <input type="number" id="prodCadenceManual" min="0" step="0.01" />
              </div>

              <div class="form-group">
                <label for="prodArretMinutes">Arr√™ts (min)</label>
                <input type="number" id="prodArretMinutes" min="0" />
              </div>

              <div class="form-group form-group-wide">
                <label for="prodComment">Commentaire</label>
                <textarea id="prodComment" rows="2"></textarea>
              </div>
            </div>

            <div class="info-row">
              <div>
                <strong>Cadence :</strong>
                <span id="prodCadenceDisplay">-</span> colis/heure
              </div>
              <div>
                <strong>Temps restant :</strong>
                <span id="prodRemainingTimeDisplay">-</span>
              </div>
            </div>

            <div class="buttons-row">
              <button id="prodSaveBtn" class="primary-btn">üíæ Enregistrer</button>
              <button id="prodUndoBtn" class="secondary-btn">‚Ü©Ô∏è Annuler dernier</button>
            </div>
          </div>

          <div class="card">
            <h3>Historique de la ligne</h3>
            <div class="table-wrapper-horizontal">
              <table class="table" id="prodHistoryTable">
                <thead>
                  <tr>
                    <th>Date/Heure</th>
                    <th>√âquipe</th>
                    <th>D√©but</th>
                    <th>Fin</th>
                    <th>Qt√©</th>
                    <th>Arr√™t</th>
                    <th>Cadence</th>
                    <th>Temps restant</th>
                    <th>Commentaire</th>
                    <th>Article</th>
                    <th>Suppr.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PAGE ARRETS -->
    <section id="section-arrets" class="section">
      <div class="card">
        <h2>Nouvel arr√™t</h2>

        <div class="form-row">
          <label for="arretLine">Ligne impact√©e :</label>
          <select id="arretLine"></select>
        </div>

        <div class="form-row">
          <label for="arretSousZone">Sous-zone :</label>
          <select id="arretSousZone"></select>
        </div>

        <div class="form-row">
          <label for="arretMachine">Machine :</label>
          <select id="arretMachine"></select>
        </div>

        <div class="form-row">
          <label for="arretArticle">Code article (optionnel)</label>
          <input type="text" id="arretArticle" />
        </div>

        <div class="form-row">
          <label for="arretDuration">Dur√©e (min) :</label>
          <input type="number" id="arretDuration" min="0" />
        </div>

        <div class="form-row">
          <label for="arretComment">Commentaire :</label>
          <textarea id="arretComment" rows="3"></textarea>
        </div>

        <button id="arretSaveBtn" class="primary-btn">üíæ Enregistrer l'arr√™t</button>
      </div>

      <div class="card">
        <h2>Historique des arr√™ts</h2>
        <div class="table-wrapper">
          <table id="arretsHistoryTable" class="data-table">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>Ligne</th>
                <th>Sous-zone</th>
                <th>Machine</th>
                <th>Article</th>
                <th>Dur√©e (min)</th>
                <th>Commentaire</th>
                <th>Suppr.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAGE ORGANISATION -->
    <section id="section-organisation" class="section">
      <h2>Organisation / Consignes</h2>

      <div class="card">
        <h3>Nouvelle consigne</h3>
        <div class="form-grid">
          <div class="form-group form-group-wide">
            <label for="orgConsigne">Consigne</label>
            <textarea id="orgConsigne" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="orgVisa">Visa</label>
            <input type="text" id="orgVisa" />
          </div>
        </div>

        <div class="buttons-row">
          <button id="orgSaveBtn" class="primary-btn">üíæ Enregistrer consigne</button>
        </div>
      </div>

      <div class="card">
        <h3>Historique des consignes</h3>
        <table class="table" id="orgHistoryTable">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>√âquipe</th>
              <th>Consigne</th>
              <th>Visa</th>
              <th>Valid√©e ?</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAGE PERSONNEL -->
    <section id="section-personnel" class="section">
      <h2>Personnel</h2>

      <div class="card">
        <h3>√âv√©nement personnel</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="persNom">Nom</label>
            <input type="text" id="persNom" />
          </div>

          <div class="form-group">
            <label for="persMotif">Motif</label>
            <select id="persMotif">
              <option value="Absence">Absence</option>
              <option value="Retard">Retard</option>
              <option value="D√©part">D√©part</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <div class="form-group form-group-wide">
            <label for="persComment">Commentaire</label>
            <textarea id="persComment" rows="2"></textarea>
          </div>
        </div>

        <div class="buttons-row">
          <button id="persSaveBtn" class="primary-btn">üíæ Enregistrer</button>
        </div>
      </div>

      <div class="card">
        <h3>Historique personnel</h3>
        <table class="table" id="persHistoryTable">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>√âquipe</th>
              <th>Nom</th>
              <th>Motif</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAGE VALIDATION DDM -->
    <section id="section-validation" class="section">
      <h2>Validation DDM</h2>

      <div class="card">
        <h3>Calcul de la DDM</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="ddmQuantieme">Quanti√®me fabrication</label>
            <input type="number" id="ddmQuantieme" min="1" max="366" placeholder="Ex: 100" />
          </div>

          <div class="form-group">
            <label for="ddmAnnee">Ann√©e fabrication</label>
            <input type="number" id="ddmAnnee" placeholder="Ex: 2024" />
          </div>

          <div class="form-group">
            <label for="ddmDuree">Dur√©e de vie (jours)</label>
            <input type="number" id="ddmDuree" min="0" placeholder="Ex: 90" />
          </div>
        </div>

        <div class="buttons-row">
          <button id="ddmCalcBtn" class="primary-btn">üßÆ Calculer DDM</button>
        </div>

        <p class="ddm-result">
          DDM calcul√©e : <strong id="ddmResult">-</strong>
        </p>
      </div>
    </section>

    <!-- PAGE HISTORIQUE EQUIPES -->
    <section id="section-historique" class="section">
      <div class="card">
        <h2>Historique des √©quipes</h2>

        <label for="historySelect">√âquipe / p√©riode enregistr√©e :</label>
        <select id="historySelect">
          <option value="">-- S√©lectionner --</option>
        </select>
      </div>

      <div class="card">
        <h3>Vue d'ensemble</h3>
        <div id="history-lines-summary" class="summary-grid"></div>
      </div>

      <div class="card">
        <h3>√âvolution des cadences</h3>
        <canvas id="historyChart"></canvas>
      </div>

      <div class="card">
        <h3>Arr√™ts (classement par dur√©e)</h3>
        <table id="history-arrets-table" class="data-table">
          <thead>
            <tr>
              <th>Ligne</th>
              <th>Sous-ligne</th>
              <th>Machine</th>
              <th>Dur√©e (min)</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="history-organisation" style="display: none;">
        <h3>Organisation / Consignes</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>√âquipe</th>
              <th>Consigne</th>
              <th>Visa</th>
              <th>Valid√©e</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="history-personnel" style="display: none;">
        <h3>Personnel</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>√âquipe</th>
              <th>Nom</th>
              <th>Motif</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAGE MANAGER (base d√©di√©e) -->
    <section id="section-manager" class="section">
      <h2>Base manager (ind√©pendante & locale)</h2>
      <p class="helper-text">
        Importe les fichiers Excel et recopie toutes les lignes dans un classeur unique g√©n√©r√© par l'application. La
        recherche parcourt l'int√©gralit√© de l'historique stock√© dans ce classeur, sans d√©pendance r√©seau.
      </p>

      <div class="card" id="managerSecurityCard">
        <h3>Acc√®s manager s√©curis√©</h3>
        <p class="helper-text">
          Configure un mot de passe local pour prot√©ger l'espace manager. Le mot de passe reste sur cet appareil et peut
          √™tre chang√© √† tout moment.
        </p>
        <div class="manager-security-grid">
          <form id="managerUnlockForm" class="manager-security-form">
            <label for="managerUnlockInput">Mot de passe</label>
            <div class="manager-security-actions">
              <input type="password" id="managerUnlockInput" placeholder="Saisis le mot de passe" />
              <button type="submit" class="primary-btn">üîì D√©verrouiller</button>
            </div>
          </form>

          <form id="managerSetPasswordForm" class="manager-security-form">
            <label for="managerPasswordInput">Nouveau mot de passe</label>
            <div class="manager-security-actions">
              <input type="password" id="managerPasswordInput" placeholder="D√©finis ou change le mot de passe" />
              <button type="submit" class="secondary-btn">üíæ Enregistrer</button>
            </div>
          </form>
        </div>
        <div id="managerSecurityStatus" class="import-status helper-text"></div>
      </div>

      <div class="manager-locked" id="managerLockedOverlay">
        <p>Acc√®s manager verrouill√©. D√©finis ou saisis le mot de passe pour afficher les donn√©es.</p>
      </div>

      <div class="manager-grid" id="managerContent">
        <div class="card">
          <h3>Import vers la base manager</h3>
          <p class="helper-text">
            Les fichiers peuvent arriver √† tout moment (jusqu'√† plusieurs par √©quipe). Aucun pr√©requis de nombre ou de
            plage horaire.
          </p>
          <div class="import-actions">
            <input type="file" id="managerExcelInput" accept=".xlsx,.xls" multiple />
            <button id="managerImportBtn" class="primary-btn">üì• Importer dans la base</button>
            <button id="managerExportBtn" class="secondary-btn" title="T√©l√©charger le classeur historis√©">üìë Export Excel</button>
            <button id="managerResetBtn" class="danger-btn" title="Effacer la base manager (pas les autres formulaires)">üóëÔ∏è Vider la base</button>
          </div>
          <div id="managerImportStatus" class="import-status helper-text"></div>

          <div class="table-wrapper-horizontal" style="margin-top: 12px;">
            <table class="table" id="managerImportsTable">
              <thead>
                <tr>
                  <th>Fichier</th>
                  <th>Q/S/Heure</th>
                  <th>Lignes</th>
                  <th>Import√© le</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Recherche et tri</h3>
          <div class="form-grid import-filters">
            <div class="form-group">
              <label for="managerSearchInput">Recherche texte</label>
              <input type="text" id="managerSearchInput" placeholder="Tape ici pour chercher dans la base" />
            </div>
            <div class="form-group">
              <label for="managerEquipeFilter">√âquipe</label>
              <select id="managerEquipeFilter">
                <option value="">Toutes</option>
                <option value="M">M</option>
                <option value="AM">AM</option>
                <option value="N">N</option>
              </select>
            </div>
            <div class="form-group">
              <label for="managerLineFilter">Ligne</label>
              <select id="managerLineFilter">
                <option value="">Toutes</option>
              </select>
            </div>
            <div class="form-group">
              <label for="managerSortField">Tri</label>
              <select id="managerSortField"></select>
            </div>
            <div class="form-group">
              <label for="managerSortDir">Ordre</label>
              <select id="managerSortDir">
                <option value="desc">D√©croissant</option>
                <option value="asc">Croissant</option>
              </select>
            </div>
          </div>

          <div class="field-selector" id="managerFieldSelector"></div>
          <p class="helper-text" id="managerResultsCount"></p>
        </div>
      </div>

      <div class="card">
        <h3>R√©sultats (base manager)</h3>
        <div class="table-wrapper-horizontal">
          <table class="table" id="managerResultsTable">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>√âquipe</th>
                <th>Ligne</th>
                <th>Sous-ligne</th>
                <th>Machine</th>
                <th>Quantit√©</th>
                <th>Arr√™t (min)</th>
                <th>Cadence</th>
                <th>Commentaire</th>
                <th>Article</th>
                <th>Personnel</th>
                <th>Motif</th>
                <th>Fichier</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CALCULATRICE FLOTTANTE -->
    <div id="calculator" class="calculator hidden">
      <div class="calc-header">
        <span>Calculatrice</span>
        <button id="calcCloseBtn" class="calc-close-btn">‚úï</button>
      </div>

      <input type="text" id="calcDisplay" class="calc-display" readonly />

      <div class="calc-grid">
        <button class="calc-btn" data-value="7">7</button>
        <button class="calc-btn" data-value="8">8</button>
        <button class="calc-btn" data-value="9">9</button>
        <button class="calc-btn op" data-value="/">√∑</button>

        <button class="calc-btn" data-value="4">4</button>
        <button class="calc-btn" data-value="5">5</button>
        <button class="calc-btn" data-value="6">6</button>
        <button class="calc-btn op" data-value="*">√ó</button>

        <button class="calc-btn" data-value="1">1</button>
        <button class="calc-btn" data-value="2">2</button>
        <button class="calc-btn" data-value="3">3</button>
        <button class="calc-btn op" data-value="-">‚àí</button>

        <button class="calc-btn" data-value="0">0</button>
        <button class="calc-btn" data-value=".">.</button>
        <button class="calc-btn" data-action="clear">C</button>
        <button class="calc-btn op" data-value="+">+</button>

        <button class="calc-btn equals" data-action="equals">=</button>
      </div>
    </div>

    <button id="calcToggle" class="calculator-toggle">üßÆ</button>

  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script src="app.js"></script>
</body>
</html>

