<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Atelier PPNC - Production lignes</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#005bff" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- IndexedDB helper (Dexie) pour la base locale du manager -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch((err) => console.error("SW registration failed", err));
      });
    }
  </script>
</head>

<body>
  <header class="app-header">
    <div class="app-title">
      <span class="app-main-title">Atelier PPNC</span>
      <span class="app-sub-title">Suivi Production & ArrÃªts</span>
    </div>
    <div class="header-info" id="header-datetime">
      <!-- injectÃ© JS -->
    </div>
    <div class="header-actions">
      <button id="settingsToggle" class="icon-btn" title="ParamÃ¨tres et sÃ©curitÃ©">âš™ï¸</button>
      <select id="equipeSelector" class="equipe-selector">
        <option value="M">Ã‰quipe M</option>
        <option value="AM">Ã‰quipe AM</option>
        <option value="N">Ã‰quipe N</option>
      </select>
      <button id="themeToggleBtn" class="theme-toggle">ğŸŒ— ThÃ¨me</button>
    </div>
  </header>

  <!-- Barre de navigation -->
  <nav class="top-nav">
    <button class="nav-btn active" data-section="atelier">Atelier</button>
    <button class="nav-btn" data-section="production">Production</button>
    <button class="nav-btn" data-section="arrets">ArrÃªts</button>
    <button class="nav-btn" data-section="organisation">Organisation</button>
    <button class="nav-btn" data-section="personnel">Personnel</button>
    <button class="nav-btn" data-section="validation">Validation DDM</button>
    <button class="nav-btn" data-section="historique">Historique Ã©quipes</button>
    <button class="nav-btn" data-section="manager">Manager (base dÃ©diÃ©e)</button>
    <button class="nav-btn" data-section="planning">Planning</button>
  </nav>

  <main>
    <!-- PAGE ATELIER -->
    <section id="section-atelier" class="section visible">
      <h2>Vue d'ensemble Atelier</h2>

      <div class="atelier-grid">
        <div class="card">
          <h3>Production par ligne (aujourd'hui)</h3>
          <div id="atelier-lines-summary"></div>
        </div>

        <div class="card">
          <h3>Mise Ã  jour Excel</h3>
          <p class="helper-text">
            Charge un ou plusieurs fichiers du type <strong>Atelier_DATA_EQN_Qxxx_Sxx_hhmm.xlsx</strong>. Pas de limite Ã  3 fichiers ni Ã  un seul import par jour.
          </p>

          <div class="import-actions">
            <input type="file" id="excelInput" accept=".xlsx,.xls" multiple />
            <button id="importExcelBtn" class="primary-btn">ğŸ“¥ Mise Ã  jour</button>
          </div>

          <div id="importStatus" class="import-status helper-text"></div>

          <div class="table-wrapper-horizontal">
            <table class="table" id="importsTable">
              <thead>
                <tr>
                  <th>Fichier</th>
                  <th>Q / S / Heure</th>
                  <th>Enregistrements</th>
                  <th>ImportÃ© le</th>
                </tr>
              </thead>
              <tbody id="importsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Ã‰volution des cadences</h3>
          <canvas id="atelierChart"></canvas>
          <p class="helper-text">
            Une courbe par ligne, basÃ©e sur les enregistrements de production.
          </p>
        </div>

        <div class="card">
          <h3>ArrÃªts principaux</h3>
          <div class="table-wrapper-horizontal">
            <table class="table" id="atelier-arrets-table">
              <thead>
                <tr>
                  <th>Ligne</th>
                  <th>Sous-ligne</th>
                  <th>Machine</th>
                  <th>DurÃ©e (min)</th>
                  <th>Commentaire</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Export Excel</h3>
          <p class="helper-text">
            Export pour prÃ©sentation en rÃ©union (5 onglets : SynthÃ¨se, Production, ArrÃªts, Organisation, Personnel).
          </p>

          <button id="exportPresentationBtn" class="primary-btn" style="margin-bottom: 15px;">
            ğŸ“ˆ Export PRÃ‰SENTATION
          </button>

          <p class="helper-text" style="margin-top: 20px;">
            RAZ d'Ã©quipe : exporte DATA + PRÃ‰SENTATION de l'Ã©quipe finissante, puis reset complet.
          </p>

          <button id="razBtn" class="danger-btn">
            ğŸ”„ RAZ Ã©quipe (double export + reset)
          </button>
        </div>
      </div>

      <div class="card">
        <h3>Recherche dans les imports Excel</h3>
        <div class="form-grid import-filters">
          <div class="form-group">
            <label for="importSearchInput">Recherche texte</label>
            <input type="text" id="importSearchInput" placeholder="Article, machine, commentaire..." />
          </div>
          <div class="form-group">
            <label for="importEquipeFilter">Ã‰quipe</label>
            <select id="importEquipeFilter">
              <option value="">Toutes</option>
              <option value="M">M</option>
              <option value="AM">AM</option>
              <option value="N">N</option>
            </select>
          </div>
          <div class="form-group">
            <label for="importLineFilter">Ligne</label>
            <select id="importLineFilter">
              <option value="">Toutes les lignes</option>
            </select>
          </div>
        </div>

        <p class="helper-text" id="importResultsCount"></p>

        <div class="table-wrapper-horizontal">
          <table class="table" id="importResultsTable">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>Ã‰quipe</th>
                <th>Ligne</th>
                <th>Machine</th>
                <th>QuantitÃ©</th>
                <th>ArrÃªt (min)</th>
                <th>Cadence</th>
                <th>Commentaire</th>
                <th>Fichier</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAGE PRODUCTION -->
    <section id="section-production" class="section">
      <div class="production-layout">
        <aside class="lines-sidebar">
          <h3>Lignes</h3>
          <div class="lines-list" id="linesList"></div>
        </aside>

        <div class="line-content">
          <h2 id="currentLineTitle">Ligne</h2>

          <div class="card">
            <h3>Saisie production</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="prodStartTime">Heure dÃ©but</label>
                <input type="time" id="prodStartTime" />
              </div>

              <div class="form-group">
                <label for="prodEndTime">Heure fin</label>
                <input type="time" id="prodEndTime" />
              </div>

              <div class="form-group">
                <label for="prodQuantity">QuantitÃ© produite (colis)</label>
                <input type="number" id="prodQuantity" min="0" />
              </div>

              <div class="form-group">
                <label for="prodCodeArticle">Code article (optionnel)</label>
                <input type="text" id="prodCodeArticle" />
              </div>

              <div class="form-group">
                <label for="prodRemaining">QuantitÃ© restante (colis)</label>
                <input type="number" id="prodRemaining" min="0" />
              </div>

              <div class="form-group">
                <label for="prodCadenceManual">Cadence manuelle (colis/h)</label>
                <input type="number" id="prodCadenceManual" min="0" step="0.01" />
              </div>

              <div class="form-group">
                <label for="prodArretMinutes">ArrÃªts (min)</label>
                <input type="number" id="prodArretMinutes" min="0" />
              </div>

              <div class="form-group form-group-wide">
                <label for="prodComment">Commentaire</label>
                <textarea id="prodComment" rows="2"></textarea>
              </div>
            </div>

            <div class="info-row">
              <div>
                <strong>Cadence :</strong>
                <span id="prodCadenceDisplay">-</span> colis/heure
              </div>
              <div>
                <strong>Temps restant :</strong>
                <span id="prodRemainingTimeDisplay">-</span>
              </div>
            </div>

            <div class="buttons-row">
              <button id="prodSaveBtn" class="primary-btn">ğŸ’¾ Enregistrer</button>
              <button id="prodUndoBtn" class="secondary-btn">â†©ï¸ Annuler dernier</button>
            </div>
          </div>

          <div class="card">
            <h3>Historique de la ligne</h3>
            <div class="table-wrapper-horizontal">
              <table class="table" id="prodHistoryTable">
                <thead>
                  <tr>
                    <th>Date/Heure</th>
                    <th>Ã‰quipe</th>
                    <th>DÃ©but</th>
                    <th>Fin</th>
                    <th>QtÃ©</th>
                    <th>ArrÃªt</th>
                    <th>Cadence</th>
                    <th>Temps restant</th>
                    <th>Commentaire</th>
                    <th>Article</th>
                    <th>Suppr.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PAGE ARRETS -->
    <section id="section-arrets" class="section">
      <div class="card">
        <h2>Nouvel arrÃªt</h2>

        <div class="form-row">
          <label for="arretLine">Ligne impactÃ©e :</label>
          <select id="arretLine"></select>
        </div>

        <div class="form-row">
          <label for="arretSousZone">Sous-zone :</label>
          <select id="arretSousZone"></select>
        </div>

        <div class="form-row">
          <label for="arretMachine">Machine :</label>
          <select id="arretMachine"></select>
        </div>

        <div class="form-row">
          <label for="arretArticle">Code article (optionnel)</label>
          <input type="text" id="arretArticle" />
        </div>

        <div class="form-row">
          <label for="arretDuration">DurÃ©e (min) :</label>
          <input type="number" id="arretDuration" min="0" />
        </div>

        <div class="form-row">
          <label for="arretComment">Commentaire :</label>
          <textarea id="arretComment" rows="3"></textarea>
        </div>

        <button id="arretSaveBtn" class="primary-btn">ğŸ’¾ Enregistrer l'arrÃªt</button>
      </div>

      <div class="card">
        <h2>Historique des arrÃªts</h2>
        <div class="table-wrapper">
          <table id="arretsHistoryTable" class="data-table">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>Ligne</th>
                <th>Sous-zone</th>
                <th>Machine</th>
                <th>Article</th>
                <th>DurÃ©e (min)</th>
                <th>Commentaire</th>
                <th>Suppr.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAGE ORGANISATION -->
    <section id="section-organisation" class="section">
      <h2>Organisation / Consignes</h2>

      <div class="card">
        <h3>Nouvelle consigne</h3>
        <div class="form-grid">
          <div class="form-group form-group-wide">
            <label for="orgConsigne">Consigne</label>
            <textarea id="orgConsigne" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="orgVisa">Visa</label>
            <input type="text" id="orgVisa" />
          </div>
        </div>

        <div class="buttons-row">
          <button id="orgSaveBtn" class="primary-btn">ğŸ’¾ Enregistrer consigne</button>
        </div>
      </div>

      <div class="card">
        <h3>Historique des consignes</h3>
        <table class="table" id="orgHistoryTable">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Ã‰quipe</th>
              <th>Consigne</th>
              <th>Visa</th>
              <th>ValidÃ©e ?</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAGE PERSONNEL -->
    <section id="section-personnel" class="section">
      <h2>Personnel</h2>

      <div class="card">
        <h3>Ã‰vÃ©nement personnel</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="persNom">Nom</label>
            <input type="text" id="persNom" />
          </div>

          <div class="form-group">
            <label for="persMotif">Motif</label>
            <select id="persMotif">
              <option value="Absence">Absence</option>
              <option value="Retard">Retard</option>
              <option value="DÃ©part">DÃ©part</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <div class="form-group form-group-wide">
            <label for="persComment">Commentaire</label>
            <textarea id="persComment" rows="2"></textarea>
          </div>
        </div>

        <div class="buttons-row">
          <button id="persSaveBtn" class="primary-btn">ğŸ’¾ Enregistrer</button>
        </div>
      </div>

      <div class="card">
        <h3>Historique personnel</h3>
        <table class="table" id="persHistoryTable">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Ã‰quipe</th>
              <th>Nom</th>
              <th>Motif</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAGE VALIDATION DDM -->
    <section id="section-validation" class="section">
      <h2>Validation DDM</h2>

      <div class="card">
        <h3>Calcul de la DDM</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="ddmQuantieme">QuantiÃ¨me fabrication</label>
            <input type="number" id="ddmQuantieme" min="1" max="366" placeholder="Ex: 100" />
          </div>

          <div class="form-group">
            <label for="ddmAnnee">AnnÃ©e fabrication</label>
            <input type="number" id="ddmAnnee" placeholder="Ex: 2024" />
          </div>

          <div class="form-group">
            <label for="ddmDuree">DurÃ©e de vie (jours)</label>
            <input type="number" id="ddmDuree" min="0" placeholder="Ex: 90" />
          </div>
        </div>

        <div class="buttons-row">
          <button id="ddmCalcBtn" class="primary-btn">ğŸ§® Calculer DDM</button>
        </div>

        <p class="ddm-result">
          DDM calculÃ©e : <strong id="ddmResult">-</strong>
        </p>
      </div>
    </section>

    <!-- PAGE HISTORIQUE EQUIPES -->
    <section id="section-historique" class="section">
      <div class="card">
        <h2>Historique des Ã©quipes</h2>

        <label for="historySelect">Ã‰quipe / pÃ©riode enregistrÃ©e :</label>
        <select id="historySelect">
          <option value="">-- SÃ©lectionner --</option>
        </select>
        <div id="historyFolderStatus" class="import-status helper-text"></div>
      </div>

      <div class="card">
        <h3>Vue d'ensemble</h3>
        <div id="history-lines-summary" class="summary-grid"></div>
      </div>

      <div class="card">
        <h3>Ã‰volution des cadences</h3>
        <canvas id="historyChart"></canvas>
      </div>

      <div class="card">
        <h3>ArrÃªts (classement par durÃ©e)</h3>
        <table id="history-arrets-table" class="data-table">
          <thead>
            <tr>
              <th>Ligne</th>
              <th>Sous-ligne</th>
              <th>Machine</th>
              <th>DurÃ©e (min)</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="history-organisation" style="display: none;">
        <h3>Organisation / Consignes</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Ã‰quipe</th>
              <th>Consigne</th>
              <th>Visa</th>
              <th>ValidÃ©e</th>
              <th>Supprimer</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="history-personnel" style="display: none;">
        <h3>Personnel</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Ã‰quipe</th>
              <th>Nom</th>
              <th>Motif</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAGE MANAGER (base dÃ©diÃ©e) -->
    <section id="section-manager" class="section">
      <h2>Base manager (indÃ©pendante & locale)</h2>
      <p class="helper-text">
        Importe les fichiers Excel et recopie toutes les lignes dans un classeur unique gÃ©nÃ©rÃ© par l'application. La
        recherche parcourt l'intÃ©gralitÃ© de l'historique stockÃ© dans ce classeur, sans dÃ©pendance rÃ©seau.
      </p>

      <div class="manager-grid" id="managerContent">
        <div class="card">
          <h3>Import vers la base manager</h3>
          <div class="info-bubble">
            <button type="button" class="icon-btn info-toggle" id="managerInfoToggle" title="DÃ©tails de la mise Ã  jour">â„¹ï¸ DÃ©tails</button>
            <div class="info-bubble__content hidden" id="managerInfoContent">
              Les fichiers peuvent arriver Ã  tout moment (jusqu'Ã  plusieurs par Ã©quipe). Clique sur Â« Mise Ã  jour Â» pour
              scanner un dossier (ex : honor200 âœ Documents) et ne rÃ©cupÃ©rer que les fichiers Excel non encore importÃ©s.
              Une vÃ©rification automatique relance ce scan toutes les 30 minutes si le dossier est autorisÃ©.
            </div>
          </div>
          <div class="import-actions">
            <input type="file" id="managerExcelInput" accept=".xlsx,.xls" multiple />
            <button id="managerScanBtn" class="primary-btn">ğŸ“‚ Mise Ã  jour (scanne un dossier)</button>
            <button id="managerImportBtn" class="secondary-btn" title="Importer manuellement plusieurs fichiers">
              ğŸ“¥ Importer une sÃ©lection
            </button>
            <button id="managerExportBtn" class="secondary-btn" title="TÃ©lÃ©charger le classeur historisÃ©">ğŸ“‘ Export Excel</button>
            <button id="managerResetBtn" class="danger-btn" title="Effacer la base manager (pas les autres formulaires)">ğŸ—‘ï¸ Vider la base</button>
          </div>
          <div id="managerImportStatus" class="import-status helper-text"></div>
          <div id="managerFolderStatus" class="import-status helper-text"></div>

        </div>

        <div class="card" id="managerSearchCard">
          <h3>Recherche et tri</h3>
          <p class="helper-text">Tape un mot-clÃ© ou combine plusieurs filtres. La recherche couvre tous les champs de l'historique.</p>
          <div class="form-grid import-filters">
            <div class="form-group">
              <label for="managerSearchInput">Recherche texte</label>
              <input type="text" id="managerSearchInput" placeholder="Tape ici pour chercher dans la base" />
            </div>
            <div class="form-group">
              <label for="managerEquipeFilter">Ã‰quipe</label>
              <select id="managerEquipeFilter">
                <option value="">Toutes</option>
                <option value="M">M</option>
                <option value="AM">AM</option>
                <option value="N">N</option>
              </select>
            </div>
            <div class="form-group">
              <label for="managerLineFilter">Ligne</label>
              <select id="managerLineFilter">
                <option value="">Toutes</option>
              </select>
            </div>
            <div class="form-group">
              <label for="managerSortField">Tri</label>
              <select id="managerSortField"></select>
            </div>
            <div class="form-group">
              <label for="managerSortDir">Ordre</label>
              <select id="managerSortDir">
                <option value="desc">DÃ©croissant</option>
                <option value="asc">Croissant</option>
              </select>
            </div>
            <div class="form-group">
              <label for="managerDateStart">DÃ©but pÃ©riode (Pareto)</label>
              <input type="date" id="managerDateStart" />
            </div>
            <div class="form-group">
              <label for="managerDateEnd">Fin pÃ©riode (Pareto)</label>
              <input type="date" id="managerDateEnd" />
            </div>
            <div class="form-group">
              <label for="managerParetoLine">Ligne (Pareto)</label>
              <select id="managerParetoLine">
                <option value="">Toutes</option>
              </select>
            </div>
            <div class="form-group pareto-action">
              <label>&nbsp;</label>
              <button id="managerParetoBtn" class="secondary-btn" type="button">ğŸ“Š Afficher le Pareto des arrÃªts</button>
            </div>
          </div>

          <div class="manager-active-filters" id="managerActiveFilters"></div>
          <div class="field-selector" id="managerFieldSelector"></div>
          <p class="helper-text" id="managerResultsCount"></p>
        </div>
      </div>

      <div class="card" id="managerResultsCard">
        <div class="manager-results-header">
          <div>
            <h3>RÃ©sultats (base manager)</h3>
            <p class="helper-text">Affichage enrichi avec rappel des mÃ©tadonnÃ©es fichier (quantiÃ¨me, semaine, heure).</p>
          </div>
          <div class="manager-result-badges" id="managerResultBadges"></div>
        </div>

        <div class="manager-results-grid">
          <div class="manager-stats" id="managerStats"></div>

          <div class="table-wrapper-horizontal">
            <table class="table manager-table" id="managerResultsTable">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Date/Heure</th>
                  <th>Ã‰quipe</th>
                  <th>Ligne</th>
                  <th>Sous-ligne</th>
                  <th>Machine</th>
                  <th>QuantitÃ©</th>
                  <th>ArrÃªt (min)</th>
                  <th>Cadence</th>
                  <th>Commentaire</th>
                  <th>Article</th>
                  <th>Personnel</th>
                  <th>Motif</th>
                  <th>Fichier (Q/S/H)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card" id="managerParetoCard" style="display: none;">
        <div class="manager-results-header">
          <div>
            <h3 id="managerParetoTitle">Pareto des arrÃªts</h3>
            <p class="helper-text" id="managerParetoSubtitle">Camembert basÃ© sur les arrÃªts (minutes) filtrÃ©s par pÃ©riode ou ligne.</p>
          </div>
          <div class="manager-result-badges" id="managerParetoBadges"></div>
        </div>
        <div class="pareto-chart-wrapper">
          <canvas id="managerPareto"></canvas>
        </div>
        <p class="helper-text pareto-click-info" id="managerParetoClickInfo"></p>
        <div class="pareto-actions">
          <button id="managerParetoBackToTop" class="secondary-btn" type="button">â¬†ï¸ Haut de page</button>
        </div>
      </div>
    </section>

    <!-- PAGE PLANNING -->
    <section id="section-planning" class="section">
      <div class="planning-tabs">
        <button class="planning-tab-btn active" data-tab="articles">ğŸ“¦ Articles</button>
        <button class="planning-tab-btn" data-tab="build">ğŸ”§ CrÃ©er Planning</button>
        <button class="planning-tab-btn" data-tab="run">ğŸ“Š Planning Actif</button>
      </div>

      <!-- TAB 1: GESTION DES ARTICLES -->
      <div id="planning-tab-articles" class="planning-pane">
        <div class="card">
          <h3>ğŸ“¦ Base Articles</h3>
          <p class="helper-text">Les articles sont permanents et utilisables pour tous vos plannings. Chaque article est liÃ© Ã  une ligne et une cadence.</p>
          
          <div class="planning-article-form">
            <div class="form-grid">
              <label>Code article *
                <input type="text" id="planningArticleCode" placeholder="Ex: ART001" />
              </label>
              <label>LibellÃ© *
                <input type="text" id="planningArticleLabel" placeholder="Ex: Emmental rÃ¢pÃ© 200g" />
              </label>
              <label>Ligne de production *
                <select id="planningArticleLine"></select>
              </label>
              <label>Cadence (colis/h) *
                <input type="number" id="planningArticleCadence" step="1" min="1" placeholder="Ex: 150" />
              </label>
              <label>Poids colis (kg)
                <input type="number" id="planningArticlePoids" step="0.01" min="0" placeholder="Ex: 2.5" />
              </label>
            </div>
            <div class="buttons-row">
              <button class="primary-btn" id="planningArticleAddBtn">â• Ajouter / Modifier</button>
              <button class="secondary-btn" id="planningArticleClearBtn">ğŸ—‘ï¸ Effacer</button>
            </div>
          </div>

          <h4>Liste des articles enregistrÃ©s</h4>
          <div class="planning-articles-list" id="planningArticlesList">
            <p class="helper-text">Aucun article enregistrÃ©.</p>
          </div>
        </div>
      </div>

      <!-- TAB 2: CRÃ‰ATION DU PLANNING -->
      <div id="planning-tab-build" class="planning-pane hidden">
        <div class="card">
          <h3>ğŸ“… ParamÃ¨tres du Planning</h3>
          <div class="planning-week-config">
            <label>Semaine nÂ°
              <input type="number" id="planningWeekNumber" min="1" max="53" />
            </label>
            <label>Lundi de rÃ©fÃ©rence
              <input type="date" id="planningWeekStart" />
            </label>
            <button class="secondary-btn" id="planningAutoWeekBtn">ğŸ“† Semaine actuelle</button>
          </div>
        </div>

        <div class="card">
          <h3>â¸ï¸ ArrÃªts PlanifiÃ©s</h3>
          <p class="helper-text">DÃ©finissez les pauses, maintenances et autres arrÃªts rÃ©currents.</p>
          <div class="form-grid">
            <label>Type d'arrÃªt
              <select id="plannedStopType">
                <option value="Pause">Pause</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Nettoyage">Nettoyage</option>
                <option value="RÃ©union">RÃ©union</option>
                <option value="Autre">Autre</option>
              </select>
            </label>
            <label>Ligne
              <select id="plannedStopLine">
                <option value="ALL">Toutes les lignes</option>
              </select>
            </label>
            <label>Jour
              <select id="plannedStopDay">
                <option value="ALL">Tous les jours</option>
                <option value="0">Lundi</option>
                <option value="1">Mardi</option>
                <option value="2">Mercredi</option>
                <option value="3">Jeudi</option>
                <option value="4">Vendredi</option>
                <option value="5">Samedi</option>
              </select>
            </label>
            <label>Heure dÃ©but
              <input type="time" id="plannedStopStart" value="12:00" />
            </label>
            <label>DurÃ©e (minutes)
              <input type="number" id="plannedStopDuration" value="30" min="5" />
            </label>
            <label>Commentaire
              <input type="text" id="plannedStopComment" placeholder="Optionnel" />
            </label>
          </div>
          <div class="buttons-row">
            <button class="secondary-btn" id="plannedStopAddBtn">â• Ajouter l'arrÃªt</button>
          </div>
          <div id="plannedStopsList" class="planned-stops-list">
            <p class="helper-text">Aucun arrÃªt planifiÃ©.</p>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ”„ Changements (entre OFs)</h3>
          <p class="helper-text">DÃ©finissez les temps de changement de format, produit, couleur, etc.</p>
          <div class="form-grid">
            <label>Type de changement
              <select id="changeoverType">
                <option value="intermediate">IntermÃ©diaire (15 min)</option>
                <option value="format">Format (30 min)</option>
                <option value="product">Produit (45 min)</option>
                <option value="color">Couleur (60 min)</option>
              </select>
            </label>
            <label>Ligne *
              <select id="changeoverLine">
                <!-- Options ajoutÃ©es par JS -->
              </select>
            </label>
            <label>Jour
              <select id="changeoverDay">
                <option value="0">Lundi</option>
                <option value="1">Mardi</option>
                <option value="2">Mercredi</option>
                <option value="3">Jeudi</option>
                <option value="4">Vendredi</option>
                <option value="5">Samedi</option>
              </select>
            </label>
            <label>Heure dÃ©but
              <input type="time" id="changeoverStart" value="06:00" />
            </label>
            <label>DurÃ©e (minutes)
              <input type="number" id="changeoverDuration" value="15" min="5" />
            </label>
            <label>Commentaire
              <input type="text" id="changeoverComment" placeholder="Optionnel" />
            </label>
          </div>
          <div class="buttons-row">
            <button class="secondary-btn" id="changeoverAddBtn">â• Ajouter le changement</button>
          </div>
          <div id="changeoversList" class="changeovers-list">
            <p class="helper-text">Aucun changement planifiÃ©.</p>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ­ CrÃ©er un Ordre de Fabrication (OF)</h3>
          <div id="planningOFNoArticles" class="helper-text warning-text">
            âš ï¸ Aucun article enregistrÃ©. CrÃ©ez d'abord des articles dans l'onglet "Articles".
          </div>
          
          <div id="planningOFForm" class="planning-of-form">
            <div class="form-grid">
              <label>Article *
                <select id="planningOFArticle">
                  <option value="">-- SÃ©lectionner un article --</option>
                </select>
              </label>
              <label>Ligne
                <select id="planningOFLine" disabled></select>
              </label>
              <label>QuantitÃ© (colis) *
                <input type="number" id="planningOFQty" min="1" placeholder="Ex: 1000" />
              </label>
              <label>Cadence (colis/h)
                <input type="number" id="planningOFCadence" step="1" min="1" readonly />
              </label>
              <label>Jour de dÃ©but *
                <select id="planningOFDay">
                  <option value="0">Lundi</option>
                  <option value="1">Mardi</option>
                  <option value="2">Mercredi</option>
                  <option value="3">Jeudi</option>
                  <option value="4">Vendredi</option>
                  <option value="5">Samedi</option>
                </select>
              </label>
              <label>Heure de dÃ©but *
                <input type="time" id="planningOFStart" value="06:00" />
              </label>
            </div>
            
            <div class="planning-of-preview">
              <div class="of-preview-item">
                <span class="of-preview-label">DurÃ©e estimÃ©e:</span>
                <span class="of-preview-value" id="planningOFDuration">--</span>
              </div>
              <div class="of-preview-item">
                <span class="of-preview-label">Fin prÃ©vue:</span>
                <span class="of-preview-value" id="planningOFEnd">--</span>
              </div>
              <div class="of-preview-item">
                <span class="of-preview-label">Prochain crÃ©neau dispo:</span>
                <span class="of-preview-value" id="planningOFNextSlot">--</span>
              </div>
            </div>

            <div class="buttons-row">
              <button class="primary-btn" id="planningOFAddBtn">â• Ajouter l'OF</button>
              <button class="secondary-btn" id="planningOFSuggestBtn">ğŸ’¡ Placer automatiquement</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ“‹ OFs du planning en cours</h3>
          <div id="planningOFList" class="planning-of-list">
            <p class="helper-text">Aucun OF ajoutÃ©. CrÃ©ez des OFs ci-dessus.</p>
          </div>
          
          <div class="buttons-row planning-validate-row">
            <button class="secondary-btn" id="planningClearAllOFBtn">ğŸ—‘ï¸ Supprimer tous les OFs</button>
            <button class="primary-btn" id="planningValidateBtn">âœ… Valider le planning</button>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ‘ï¸ PrÃ©visualisation Gantt</h3>
          <div id="planningPreviewGantt" class="gantt-container">
            <div class="gantt-empty">Ajoutez des OFs pour voir la prÃ©visualisation</div>
          </div>
        </div>
      </div>

      <!-- TAB 3: PLANNING ACTIF -->
      <div id="planning-tab-run" class="planning-pane hidden">
        <div class="card">
          <h3>ğŸ“Š SÃ©lection du Planning</h3>
          <div class="planning-select-row">
            <label>Planning validÃ©
              <select id="planningSelectWeek">
                <option value="">-- SÃ©lectionner un planning --</option>
              </select>
            </label>
            <button class="primary-btn" id="planningLaunchBtn">ğŸš€ Charger</button>
          </div>
          <div id="planningActiveInfo" class="planning-active-info hidden">
            <span class="planning-active-badge">Planning actif: Semaine <span id="planningActiveWeek">--</span></span>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ“ˆ Diagramme de Gantt</h3>
          <div class="planning-legend">
            <span class="legend-item"><span class="legend-dot planned"></span>PlanifiÃ©</span>
            <span class="legend-item"><span class="legend-dot running"></span>En cours</span>
            <span class="legend-item"><span class="legend-dot done"></span>TerminÃ©</span>
            <span class="legend-item"><span class="legend-dot late"></span>En retard</span>
            <span class="legend-item"><span class="legend-dot stop"></span>ArrÃªt</span>
          </div>
          <div id="planningGantt" class="gantt-container">
            <div class="gantt-empty">SÃ©lectionnez un planning pour l'afficher</div>
          </div>
        </div>

        <div class="card">
          <h3>â±ï¸ Avance / Retard par ligne</h3>
          <button class="secondary-btn" id="planningRefreshBtn" style="margin-bottom: 12px;">ğŸ”„ RafraÃ®chir depuis Production/ArrÃªts</button>
          <div id="planningDelaysContainer" class="planning-delays-container">
            <p class="helper-text">Chargez un planning pour voir l'avance/retard.</p>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ“ Liste des OFs</h3>
          <div id="planningActiveOFList" class="planning-of-list">
            <p class="helper-text">Aucun planning chargÃ©.</p>
          </div>
        </div>
      </div>

      <!-- MODAL: Ã‰dition OF -->
      <div id="planningOFEditModal" class="modal hidden">
        <div class="modal-content">
          <div class="modal-header">
            <h3>âœï¸ Modifier l'OF</h3>
            <button class="icon-btn" id="planningOFEditClose">âœ–</button>
          </div>
          <div class="form-grid">
            <label>QuantitÃ© (colis)
              <input type="number" id="planningEditOFQty" min="1" />
            </label>
            <label>Jour
              <select id="planningEditOFDay">
                <option value="0">Lundi</option>
                <option value="1">Mardi</option>
                <option value="2">Mercredi</option>
                <option value="3">Jeudi</option>
                <option value="4">Vendredi</option>
                <option value="5">Samedi</option>
              </select>
            </label>
            <label>Heure dÃ©but
              <input type="time" id="planningEditOFStart" />
            </label>
            <label>Statut
              <select id="planningEditOFStatus">
                <option value="planned">PlanifiÃ©</option>
                <option value="running">En cours</option>
                <option value="done">TerminÃ©</option>
                <option value="blocked">BloquÃ©</option>
              </select>
            </label>
          </div>
          <div class="buttons-row">
            <button class="danger-btn" id="planningEditOFDelete">ğŸ—‘ï¸ Supprimer</button>
            <button class="primary-btn" id="planningEditOFSave">ğŸ’¾ Enregistrer</button>
          </div>
        </div>
      </div>
    </section>


    <!-- PANNEAU PARAMÃˆTRES -->
    <div id="settingsPanel" class="settings-panel hidden">
      <div class="settings-panel__header">
        <h3>ParamÃ¨tres</h3>
        <button id="settingsClose" class="icon-btn" aria-label="Fermer">âœ•</button>
      </div>
      <p class="helper-text">Mot de passe local, thÃ¨me et options rapides. Rien n'est envoyÃ© en ligne.</p>

      <div class="settings-grid">
        <div class="card compact">
          <h4>AccÃ¨s Manager</h4>
          <form id="settingsCreatePasswordForm" class="manager-security-form">
            <label for="settingsCreatePassword">CrÃ©er le mot de passe</label>
            <input type="password" id="settingsCreatePassword" placeholder="Mot de passe" />
            <input type="password" id="settingsCreatePasswordConfirm" placeholder="Confirmation" />
            <button type="submit" class="secondary-btn">ğŸ’¾ Enregistrer</button>
          </form>

          <form id="settingsChangePasswordForm" class="manager-security-form">
            <label for="settingsOldPassword">Modifier le mot de passe</label>
            <input type="password" id="settingsOldPassword" placeholder="Ancien mot de passe" />
            <input type="password" id="settingsNewPassword" placeholder="Nouveau mot de passe" />
            <input type="password" id="settingsNewPasswordConfirm" placeholder="Confirmer le nouveau" />
            <button type="submit" class="secondary-btn">ğŸ” Mettre Ã  jour</button>
          </form>

          <div id="settingsSecurityStatus" class="import-status helper-text"></div>
        </div>

        <div class="card compact">
          <h4>Dossier des fichiers Excel</h4>
          <p class="helper-text">Imports, exports et historique utilisent ce dossier (ex : honor200 âœ Documents).</p>
          <div class="settings-folder-row">
            <div>
              <p id="settingsFolderPath" class="helper-text folder-path">Dossier actuel : Documents</p>
              <div id="settingsFolderStatus" class="import-status helper-text"></div>
            </div>
            <button id="settingsFolderBtn" class="secondary-btn" type="button">ğŸ“ Choisir le dossier</button>
          </div>
        </div>

        <div class="card compact">
          <h4>Affichage</h4>
          <div class="settings-toggle-row">
            <span>ThÃ¨me clair / sombre</span>
            <button id="settingsThemeBtn" class="secondary-btn" type="button">Basculer</button>
          </div>
          <div class="settings-toggle-row">
            <span>RÃ©duire le bandeau</span>
            <label class="switch">
              <input type="checkbox" id="headerCompactToggle" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div id="managerUnlockModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="managerUnlockTitle">
      <div class="modal__content">
        <div class="modal__header">
          <h3 id="managerUnlockTitle">AccÃ¨s Manager</h3>
          <button id="managerUnlockClose" class="icon-btn" aria-label="Fermer">âœ•</button>
        </div>
        <p class="helper-text">Saisis le mot de passe pour afficher la page Manager (par dÃ©faut : 3005 tant qu'il n'est pas changÃ©).</p>
        <form id="managerUnlockForm" class="manager-security-form">
          <input type="password" id="managerUnlockInput" placeholder="Mot de passe" autocomplete="current-password" />
          <div class="modal__actions">
            <button type="submit" class="primary-btn">Valider</button>
            <button type="button" id="managerUnlockCancel" class="secondary-btn">Annuler</button>
          </div>
        </form>
        <div id="managerUnlockStatus" class="import-status helper-text"></div>
      </div>
    </div>

    <!-- CALCULATRICE FLOTTANTE -->
    <div id="calculator" class="calculator hidden">
      <div class="calc-header">
        <span>Calculatrice</span>
        <button id="calcCloseBtn" class="calc-close-btn">âœ•</button>
      </div>

      <input type="text" id="calcDisplay" class="calc-display" readonly />

      <div class="calc-grid">
        <button class="calc-btn" data-value="7">7</button>
        <button class="calc-btn" data-value="8">8</button>
        <button class="calc-btn" data-value="9">9</button>
        <button class="calc-btn op" data-value="/">Ã·</button>

        <button class="calc-btn" data-value="4">4</button>
        <button class="calc-btn" data-value="5">5</button>
        <button class="calc-btn" data-value="6">6</button>
        <button class="calc-btn op" data-value="*">Ã—</button>

        <button class="calc-btn" data-value="1">1</button>
        <button class="calc-btn" data-value="2">2</button>
        <button class="calc-btn" data-value="3">3</button>
        <button class="calc-btn op" data-value="-">âˆ’</button>

        <button class="calc-btn" data-value="0">0</button>
        <button class="calc-btn" data-value=".">.</button>
        <button class="calc-btn" data-action="clear">C</button>
        <button class="calc-btn op" data-value="+">+</button>

        <button class="calc-btn equals" data-action="equals">=</button>
      </div>
    </div>

    <button id="calcToggle" class="calculator-toggle">ğŸ§®</button>

  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script src="app.js"></script>
  <!-- MODULE PLANNING v2 -->
  <script src="planning.js"></script>
</body>
</html>

